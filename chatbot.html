<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Чат-бот Sirius Future</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
    }
    #chatbot-toggle {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4782, #ff6d6d);
      color: #fff;
      border: none;
      border-radius: 30px;
      height: 50px;
      padding: 0 16px;
      font-size: 16px;
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #chatbot-toggle img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    #chatbot-toggle:hover {
      filter: brightness(0.95);
    }
    #chatbot-container {
      position: absolute;
      bottom: 90px;
      right: 20px;
      width: 380px;
      height: 520px;
      background: #fff;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      z-index: 9999;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #exit-chat-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      background: transparent;
      border: none;
      font-size: 18px;
      cursor: pointer;
      z-index: 10000;
      color: #333;
    }
    #exit-chat-btn:hover {
      color: #ff6d6d;
    }
    #policy-header {
      background: #f8f8f8;
      padding: 8px;
      text-align: center;
      font-size: 13px;
      line-height: 1.2em;
      border-bottom: 1px solid #ccc;
      margin-bottom: 8px;
    }
    #policy-header a {
      color: #ff6d6d;
      text-decoration: none;
    }
    #policy-header a:hover {
      text-decoration: underline;
    }
    #chat-log {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #fff;
      color: #333;
      scroll-behavior: smooth;
    }
    #chat-log::-webkit-scrollbar {
      width: 8px;
    }
    #chat-log::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    #chat-log::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }
    #chat-log::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    .user-message {
      display: inline-block;
      clear: both;
      float: right;
      margin: 6px 0;
      background: #007bff;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .bot-message {
      clear: both;
      display: flex;
      align-items: flex-start;
      margin: 6px 0;
      float: left;
      max-width: 80%;
      word-wrap: break-word;
    }
    .assistant-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }
    .bot-text {
      background: #eaeaea;
      color: #333;
      padding: 8px 12px;
      border-radius: 8px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    #suggestions-wrapper {
      position: relative;
      background: #f8f8f8;
      padding: 8px 32px;
    }
    #suggestions-panel {
      display: grid;
      grid-auto-flow: column;
      grid-template-rows: repeat(2, auto);
      gap: 8px;
      overflow-x: scroll;
      scroll-behavior: smooth;
      scrollbar-width: none;
      -ms-overflow-style: none;
      height: auto;
    }
    #suggestions-panel::-webkit-scrollbar {
      display: none;
    }
    .scroll-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      background: transparent;
      color: #333;
      cursor: pointer;
      opacity: 0.7;
      z-index: 10;
      font-size: 16px;
      line-height: 24px;
      text-align: center;
      padding: 0;
    }
    .scroll-btn:hover {
      opacity: 1;
    }
    #left-scroll-btn {
      left: 8px;
    }
    #right-scroll-btn {
      right: 8px;
    }
    .suggestion-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: #eaeaea;
      color: #333;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      width: auto;
    }
    .suggestion-button:hover {
      background-color: #ddd;
    }
    #chat-footer {
      display: flex;
      align-items: center;
      padding: 0 10px;
      background: #fff;
      border-top: 1px solid #eee;
    }
    #user-input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      padding: 10px 0;
      font-size: 14px;
      color: #333;
    }
    #user-input::placeholder {
      color: #aaa;
    }
    #send-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      outline: none;
      margin-left: 8px;
      font-size: 20px;
      color: #ff6d6d;
    }
    #send-btn:hover {
      color: #ff4782;
    }
  </style>
</head>
<body>
  <button id="chatbot-toggle">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTdIIG48LGHqSQAQ2wXoOaYitN-bbaaV7COKQ&s" alt="Assistant">
    Задать вопрос
  </button>
  <div id="chatbot-container">
    <button id="exit-chat-btn">×</button>
    <div id="chat-log"></div>
    <div id="suggestions-wrapper">
      <button id="left-scroll-btn" class="scroll-btn">‹</button>
      <button id="right-scroll-btn" class="scroll-btn">›</button>
      <div id="suggestions-panel"></div>
    </div>
    <div id="chat-footer">
      <input id="user-input" type="text" placeholder="Введите вопрос..." />
      <button id="send-btn">➤</button>
    </div>
  </div>

  <script>
    const PARENT_ORIGIN = '*';  // Ваш хост может заменить '*' на точный origin

    // UUID для пользователя
    function generateUUID() {
      return 'xxxxxxxxyxxxxxyxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return r.toString(16);
      });
    }
    let userId = localStorage.getItem('chatbot_user_id');
    if (!userId) {
      userId = generateUUID();
      localStorage.setItem('chatbot_user_id', userId);
    }

    // История и флаг загрузки
    let chatHistory = [];
    let historyLoaded = false;

    // Элементы
    const chatToggleButton = document.getElementById('chatbot-toggle');
    const chatbotContainer  = document.getElementById('chatbot-container');
    const chatLog           = document.getElementById('chat-log');
    const userInput         = document.getElementById('user-input');
    const sendBtn           = document.getElementById('send-btn');
    const exitChatBtn       = document.getElementById('exit-chat-btn');
    const leftScrollBtn     = document.getElementById('left-scroll-btn');
    const rightScrollBtn    = document.getElementById('right-scroll-btn');
    const suggestionsPanel  = document.getElementById('suggestions-panel');

    // Вывод одного сообщения
    function displayMessage(role, text, suggestions = []) {
      if (role === 'user') {
        chatLog.innerHTML += `<div class="user-message">${text}</div>`;
      } else {
        chatLog.innerHTML += `
          <div class="bot-message">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTdIIG48LGHqSQAQ2wXoOaYitN-bbaaV7COKQ&s"
                 class="assistant-avatar" alt="Chat Assistant">
            <div class="bot-text">${text}</div>
          </div>`;
        suggestionsPanel.innerHTML = '';
        suggestions.forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'suggestion-button';
          btn.textContent = s;
          btn.onclick = () => sendMessageByText(s);
          suggestionsPanel.appendChild(btn);
        });
      }
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Добавление сообщения в историю + уведомление родителя
    function appendMessage(role, text, suggestions = []) {
      chatHistory.push({ role, content: text, suggestions });
      displayMessage(role, text, suggestions);
      window.parent.postMessage(
        { type: 'SAVE_HISTORY', payload: chatHistory },
        PARENT_ORIGIN
      );
    }

    // Отрисовать ранее загруженные сообщения
    function renderHistory() {
      chatHistory.forEach(msg =>
        displayMessage(msg.role, msg.content, msg.suggestions || [])
      );
    }

    // Приветствие по умолчанию
    function initialGreeting() {
      chatLog.innerHTML = `
        <div id="policy-header">
          При отправке данных вы соглашаетесь с 
          <a href="https://siriusfuture.ru/legal/politika" target="_blank">
            политикой обработки персональных данных
          </a>
        </div>`;
      appendMessage('bot',
        'Рады приветствовать вас в Sirius Future! Хотите что-то уточнить?',
        ['Запишите на вводное занятие','Расскажите о стоимости','У меня другой вопрос']
      );
    }

    // Приём истории от родителя
    window.addEventListener('message', event => {
      // При желании здесь можно проверять event.origin
      const msg = event.data;
      if (msg.type === 'LOAD_HISTORY' && Array.isArray(msg.payload)) {
        chatHistory   = msg.payload;
        historyLoaded = true;
        renderHistory();
      }
    });

    // Старт: запрос истории и fallback-приветствие
    window.addEventListener('DOMContentLoaded', () => {
      // Попросить родителя прислать историю
      window.parent.postMessage({ type: 'REQUEST_HISTORY' }, PARENT_ORIGIN);

      // Если через 100 мс не пришла ни одна LOAD_HISTORY — показываем стандартное приветствие
      setTimeout(() => {
        if (!historyLoaded) {
          historyLoaded = true;
          initialGreeting();
        }
      }, 100);
    });

    // Управление видимостью
    chatToggleButton.onclick = () => {
      chatbotContainer.style.display =
        chatbotContainer.style.display === 'flex' ? 'none' : 'flex';
    };
    exitChatBtn.onclick = () => chatbotContainer.style.display = 'none';
    leftScrollBtn.onclick = () => suggestionsPanel.scrollLeft -= 150;
    rightScrollBtn.onclick = () => suggestionsPanel.scrollLeft += 150;

    // Отправка запроса в AI
    async function sendMessageByText(text) {
      if (!text) return;
      appendMessage('user', text);
      userInput.value = '';
      try {
        const res = await fetch(
          'https://ai-sirius-test-3cca67054617.herokuapp.com/api/get_answer_async',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, text })
          }
        );
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        let suggestions = [];
        if (data.button_answer) {
          suggestions = data.button_answer
            .replace(/^\[|\]$/g, '')
            .split(',')
            .map(s => s.trim())
            .filter(s => s);
        }
        appendMessage('bot', data.message, suggestions);
        if (data.show_form) displayTrialForm();
      } catch (err) {
        console.error(err);
        appendMessage('bot', 'Ошибка сервера или сети');
      }
    }

    sendBtn.onclick = () => sendMessageByText(userInput.value.trim());
    userInput.onkeydown = e => { if (e.key === 'Enter') sendMessageByText(userInput.value.trim()); };

    // Форма записи на пробный урок
    function displayTrialForm() {
      const formHtml = `
        <form id="trialForm" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">
          <label>Ваше имя</label>
          <input type="text" name="parentName" placeholder="Ваше имя" required>
          <label>Номер телефона</label>
          <input type="text" name="phone" placeholder="+7..." required>
          <label>Имя ребёнка</label>
          <input type="text" name="childName" placeholder="Имя ребёнка" required>
          <label>Возраст ребёнка</label>
          <input type="number" name="childAge" placeholder="Возраст" required>
          <button type="submit">Далее</button>
        </form>`;
      appendMessage('bot',
        `Отлично! Чтобы записаться на пробный урок, заполните форму ниже:\n${formHtml}`,
        []
      );

      const form = document.getElementById('trialForm');
      form.onsubmit = async e => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          user_id:    userId,
          parentName: fd.get('parentName'),
          phone:      fd.get('phone'),
          childName:  fd.get('childName'),
          childAge:   fd.get('childAge'),
        };
        try {
          const res = await fetch(
            'https://ai-sirius-test-3cca67054617.herokuapp.com/trial-lesson',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }
          );
          if (!res.ok) throw new Error(res.status);
          appendMessage('bot', 'Спасибо! Ваша заявка принята, мы скоро свяжемся с вами.');
          form.remove();
        } catch {
          appendMessage('bot', 'Ваша заявка получена, менеджер свяжется с вами в ближайшее время.');
        }
      };
    }
  </script>
</body>
</html>
